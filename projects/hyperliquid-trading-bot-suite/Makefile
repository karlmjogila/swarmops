# Hyperliquid Trading Bot Suite - Development Makefile

.PHONY: help setup dev test clean build deploy lint format docs

# Default target
help:
	@echo "ğŸš€ Hyperliquid Trading Bot Suite - Development Commands"
	@echo ""
	@echo "ğŸ“¦ Setup Commands:"
	@echo "  make setup          Setup complete development environment"
	@echo "  make install        Install all dependencies"
	@echo "  make env            Copy environment template"
	@echo ""
	@echo "ğŸƒ Development Commands:"
	@echo "  make dev            Start development servers (backend + frontend)"
	@echo "  make backend        Start backend development server"
	@echo "  make frontend       Start frontend development server"
	@echo "  make db             Start database and redis services"
	@echo ""
	@echo "ğŸ§ª Testing Commands:"
	@echo "  make test           Run all tests"
	@echo "  make test-backend   Run backend tests"
	@echo "  make test-frontend  Run frontend tests"
	@echo "  make coverage       Generate test coverage report"
	@echo ""
	@echo "ğŸ”§ Database Commands:"
	@echo "  make migrate        Run database migrations"
	@echo "  make migration      Create new migration"
	@echo "  make db-reset       Reset database (âš ï¸  destroys data)"
	@echo ""
	@echo "ğŸ“ Code Quality:"
	@echo "  make lint           Run all linters"
	@echo "  make format         Format all code"
	@echo "  make type-check     Run type checking"
	@echo ""
	@echo "ğŸ³ Docker Commands:"
	@echo "  make docker         Start all services with Docker"
	@echo "  make docker-build   Build Docker images"
	@echo "  make docker-clean   Clean Docker containers and images"
	@echo ""
	@echo "ğŸš¢ Deployment:"
	@echo "  make build          Build production assets"
	@echo "  make deploy         Deploy to production"

# Setup targets
setup: env install migrate
	@echo "âœ… Setup complete! Run 'make dev' to start development servers."

env:
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "ğŸ“ Created .env from template. Please update with your configuration."; \
	else \
		echo "ğŸ“ .env already exists."; \
	fi

install: install-backend install-frontend
	@echo "âœ… All dependencies installed"

install-backend:
	@echo "ğŸ“¦ Installing backend dependencies..."
	cd backend && python -m pip install -e .

install-frontend:
	@echo "ğŸ“¦ Installing frontend dependencies..."
	cd frontend && npm install

# Development targets
dev: db
	@echo "ğŸš€ Starting development servers..."
	@make -j 2 backend frontend

backend:
	@echo "ğŸ Starting backend server..."
	cd backend && uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000

frontend:
	@echo "ğŸ¨ Starting frontend server..."
	cd frontend && npm run dev

db:
	@echo "ğŸ—„ï¸ Starting database services..."
	docker-compose up -d postgres redis
	@echo "â³ Waiting for services to be ready..."
	@sleep 5

# Database targets
migrate:
	@echo "ğŸ“Š Running database migrations..."
	cd backend && alembic upgrade head

migration:
	@read -p "Migration description: " desc; \
	cd backend && alembic revision --autogenerate -m "$$desc"

db-reset:
	@echo "âš ï¸  This will destroy all data in the database!"
	@read -p "Are you sure? (y/N): " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker-compose down -v; \
		docker-compose up -d postgres redis; \
		sleep 10; \
		cd backend && alembic upgrade head; \
		echo "ğŸ—„ï¸ Database reset complete"; \
	else \
		echo "âŒ Cancelled"; \
	fi

# Testing targets
test: test-backend test-frontend
	@echo "âœ… All tests completed"

test-backend:
	@echo "ğŸ§ª Running backend tests..."
	cd backend && pytest

test-frontend:
	@echo "ğŸ§ª Running frontend tests..."
	cd frontend && npm run test

coverage:
	@echo "ğŸ“Š Generating test coverage..."
	cd backend && pytest --cov=src --cov-report=html
	@echo "ğŸ“Š Coverage report generated in backend/htmlcov/index.html"

# Code quality targets
lint: lint-backend lint-frontend
	@echo "âœ… All linting completed"

lint-backend:
	@echo "ğŸ” Linting backend..."
	cd backend && ruff check .
	cd backend && mypy .

lint-frontend:
	@echo "ğŸ” Linting frontend..."
	cd frontend && npm run lint

format: format-backend format-frontend
	@echo "âœ… All code formatted"

format-backend:
	@echo "ğŸ¨ Formatting backend code..."
	cd backend && black .
	cd backend && ruff check . --fix

format-frontend:
	@echo "ğŸ¨ Formatting frontend code..."
	cd frontend && npm run lint:fix

type-check:
	@echo "ğŸ” Running type checks..."
	cd backend && mypy .
	cd frontend && npm run type-check

# Docker targets
docker:
	@echo "ğŸ³ Starting all services with Docker..."
	docker-compose up --build

docker-build:
	@echo "ğŸ—ï¸ Building Docker images..."
	docker-compose build

docker-clean:
	@echo "ğŸ§¹ Cleaning Docker containers and images..."
	docker-compose down -v --remove-orphans
	docker system prune -f

# Build and deployment
build: build-backend build-frontend
	@echo "âœ… Production build completed"

build-backend:
	@echo "ğŸ—ï¸ Building backend..."
	cd backend && python -m build

build-frontend:
	@echo "ğŸ—ï¸ Building frontend..."
	cd frontend && npm run build

deploy:
	@echo "ğŸš¢ Deploying to production..."
	@echo "âš ï¸  Deployment configuration needed - check docker-compose.prod.yml"
	# docker-compose -f docker-compose.prod.yml up -d

# Utility targets
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cd backend && rm -rf build/ dist/ *.egg-info/ .pytest_cache/ .coverage htmlcov/
	cd frontend && rm -rf .nuxt/ dist/ .output/ node_modules/.cache/
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete

docs:
	@echo "ğŸ“š Generating documentation..."
	@echo "ğŸ“– API docs available at: http://localhost:8000/docs"
	@echo "ğŸ“– Frontend docs available at: http://localhost:3000"

# Status check
status:
	@echo "ğŸ” System Status Check"
	@echo ""
	@echo "ğŸ“¦ Dependencies:"
	@command -v python3 >/dev/null 2>&1 && echo "  âœ… Python $(python3 --version)" || echo "  âŒ Python not found"
	@command -v node >/dev/null 2>&1 && echo "  âœ… Node $(node --version)" || echo "  âŒ Node.js not found"  
	@command -v docker >/dev/null 2>&1 && echo "  âœ… Docker $(docker --version)" || echo "  âŒ Docker not found"
	@echo ""
	@echo "ğŸ³ Services:"
	@docker-compose ps 2>/dev/null || echo "  âŒ Docker Compose not running"
	@echo ""
	@echo "ğŸ“ Files:"
	@[ -f .env ] && echo "  âœ… .env file exists" || echo "  âš ï¸  .env file missing (run 'make env')"
	@[ -f backend/requirements.txt ] && echo "  âœ… Backend dependencies defined" || echo "  âŒ Backend requirements missing"
	@[ -f frontend/package.json ] && echo "  âœ… Frontend dependencies defined" || echo "  âŒ Frontend package.json missing"