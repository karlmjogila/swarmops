suite: secret tests
templates:
  - secret.yaml
tests:
  - it: should create secret when enabled
    set:
      secrets.create: true
    asserts:
      - isKind:
          of: Secret
        documentIndex: 0
      - equal:
          path: metadata.name
          value: RELEASE-NAME-hyperliquid-bot
        documentIndex: 0

  - it: should not create secret when disabled
    set:
      secrets.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create secret when using existing secret
    set:
      secrets.create: true
      secrets.existingSecret: my-existing-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: should set database username
    set:
      secrets.create: true
      secrets.database.username: myuser
    asserts:
      - equal:
          path: data["database-username"]
          value: bXl1c2Vy
        documentIndex: 0

  - it: should set database password
    set:
      secrets.create: true
      secrets.database.password: mypassword
    asserts:
      - equal:
          path: data["database-password"]
          value: bXlwYXNzd29yZA==
        documentIndex: 0

  - it: should set redis password
    set:
      secrets.create: true
      secrets.redis.password: redispass
    asserts:
      - equal:
          path: data["redis-password"]
          value: cmVkaXNwYXNz
        documentIndex: 0

  - it: should set API keys
    set:
      secrets.create: true
      secrets.apiKeys.anthropicApiKey: sk-test-key
    asserts:
      - equal:
          path: data["anthropic-api-key"]
          value: c2stdGVzdC1rZXk=
        documentIndex: 0

  - it: should set Hyperliquid credentials
    set:
      secrets.create: true
      secrets.hyperliquid.privateKey: "0x123456789abcdef"
      secrets.hyperliquid.walletAddress: "0xabc123def456"
    asserts:
      - equal:
          path: data["hyperliquid-private-key"]
          value: MHgxMjM0NTY3ODlhYmNkZWY=
        documentIndex: 0
      - equal:
          path: data["hyperliquid-wallet-address"]
          value: MHhhYmMxMjNkZWY0NTY=
        documentIndex: 0

  - it: should set application secrets
    set:
      secrets.create: true
      secrets.app.secretKey: mysecretkey
      secrets.app.jwtSecretKey: myjwtsecret
    asserts:
      - equal:
          path: data["secret-key"]
          value: bXlzZWNyZXRrZXk=
        documentIndex: 0
      - equal:
          path: data["jwt-secret-key"]
          value: bXlqd3RzZWNyZXQ=
        documentIndex: 0

  - it: should have correct labels
    set:
      secrets.create: true
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: hyperliquid-bot
            app.kubernetes.io/instance: RELEASE-NAME
        documentIndex: 0

  - it: should be of type Opaque
    set:
      secrets.create: true
    asserts:
      - equal:
          path: type
          value: Opaque
        documentIndex: 0
