suite: backend deployment tests
templates:
  - deployment.yaml
  - configmap.yaml
  - secret.yaml
tests:
  - it: should render backend deployment when enabled
    set:
      backend.enabled: true
    template: deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-hyperliquid-bot-backend

  - it: should not render when backend is disabled
    set:
      backend.enabled: false
    template: deployment.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should use the correct image
    set:
      backend.image.repository: my-registry/backend
      backend.image.tag: "2.0.0"
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: my-registry/backend:2.0.0

  - it: should set correct replica count when HPA is disabled
    set:
      backend.autoscaling.enabled: false
      backend.replicaCount: 5
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  - it: should not set replica count when HPA is enabled
    set:
      backend.autoscaling.enabled: true
    template: deployment.yaml
    asserts:
      - notExists:
          path: spec.replicas

  - it: should set correct resource limits
    set:
      backend.resources.limits.cpu: "8"
      backend.resources.limits.memory: 16Gi
      backend.resources.requests.cpu: "2"
      backend.resources.requests.memory: 4Gi
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "8"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 16Gi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: "2"
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 4Gi

  - it: should apply security context
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  - it: should have correct labels
    template: deployment.yaml
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/component: backend
            app.kubernetes.io/name: hyperliquid-bot
            app.kubernetes.io/instance: RELEASE-NAME

  - it: should have prometheus annotations when enabled
    set:
      backend.podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: "8000"

  - it: should configure liveness probe correctly
    set:
      backend.livenessProbe.enabled: true
      backend.livenessProbe.httpGet.path: /api/health
      backend.livenessProbe.initialDelaySeconds: 60
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /api/health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 60

  - it: should configure readiness probe correctly
    set:
      backend.readinessProbe.enabled: true
      backend.readinessProbe.httpGet.path: /api/health
      backend.readinessProbe.initialDelaySeconds: 30
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /api/health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 30

  - it: should mount tmp volume for read-only filesystem
    template: deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: tmp
            mountPath: /tmp
      - contains:
          path: spec.template.spec.volumes
          content:
            name: tmp
            emptyDir: {}

  - it: should set node selector when specified
    set:
      backend.nodeSelector:
        kubernetes.io/os: linux
        node-type: compute
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            kubernetes.io/os: linux
            node-type: compute

  - it: should set tolerations when specified
    set:
      backend.tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "trading"
          effect: "NoSchedule"
    template: deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "dedicated"
            operator: "Equal"
            value: "trading"
            effect: "NoSchedule"

  - it: should use rolling update strategy
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 1
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 0
