{{- if and .Values.secrets.create (not .Values.secrets.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "hyperliquid-bot.fullname" . }}
  namespace: {{ include "hyperliquid-bot.namespace" . }}
  labels:
    {{- include "hyperliquid-bot.labels" . | nindent 4 }}
  {{- with .Values.secrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
type: Opaque
data:
  # Database credentials
  database-username: {{ .Values.secrets.database.username | b64enc | quote }}
  {{- if .Values.secrets.database.password }}
  database-password: {{ .Values.secrets.database.password | b64enc | quote }}
  {{- end }}
  
  # Redis credentials
  {{- if .Values.secrets.redis.password }}
  redis-password: {{ .Values.secrets.redis.password | b64enc | quote }}
  {{- end }}
  
  # API Keys
  {{- if .Values.secrets.apiKeys.anthropicApiKey }}
  anthropic-api-key: {{ .Values.secrets.apiKeys.anthropicApiKey | b64enc | quote }}
  {{- end }}
  {{- if .Values.secrets.apiKeys.openaiApiKey }}
  openai-api-key: {{ .Values.secrets.apiKeys.openaiApiKey | b64enc | quote }}
  {{- end }}
  
  # Hyperliquid credentials
  {{- if .Values.secrets.hyperliquid.privateKey }}
  hyperliquid-private-key: {{ .Values.secrets.hyperliquid.privateKey | b64enc | quote }}
  {{- end }}
  {{- if .Values.secrets.hyperliquid.walletAddress }}
  hyperliquid-wallet-address: {{ .Values.secrets.hyperliquid.walletAddress | b64enc | quote }}
  {{- end }}
  
  # Application secrets
  {{- if .Values.secrets.app.secretKey }}
  secret-key: {{ .Values.secrets.app.secretKey | b64enc | quote }}
  {{- end }}
  {{- if .Values.secrets.app.jwtSecretKey }}
  jwt-secret-key: {{ .Values.secrets.app.jwtSecretKey | b64enc | quote }}
  {{- end }}
{{- end }}
---
{{- if .Values.externalSecrets.enabled }}
{{- if eq .Values.externalSecrets.backend "vault" }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "hyperliquid-bot.fullname" . }}
  namespace: {{ include "hyperliquid-bot.namespace" . }}
  labels:
    {{- include "hyperliquid-bot.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | quote }}
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: {{ include "hyperliquid-bot.fullname" . }}
    creationPolicy: Owner
  data:
    - secretKey: database-username
      remoteRef:
        key: {{ .Values.externalSecrets.vault.path }}
        property: database-username
    - secretKey: database-password
      remoteRef:
        key: {{ .Values.externalSecrets.vault.path }}
        property: database-password
    - secretKey: redis-password
      remoteRef:
        key: {{ .Values.externalSecrets.vault.path }}
        property: redis-password
    - secretKey: anthropic-api-key
      remoteRef:
        key: {{ .Values.externalSecrets.vault.path }}
        property: anthropic-api-key
    - secretKey: openai-api-key
      remoteRef:
        key: {{ .Values.externalSecrets.vault.path }}
        property: openai-api-key
    - secretKey: hyperliquid-private-key
      remoteRef:
        key: {{ .Values.externalSecrets.vault.path }}
        property: hyperliquid-private-key
    - secretKey: hyperliquid-wallet-address
      remoteRef:
        key: {{ .Values.externalSecrets.vault.path }}
        property: hyperliquid-wallet-address
    - secretKey: secret-key
      remoteRef:
        key: {{ .Values.externalSecrets.vault.path }}
        property: secret-key
    - secretKey: jwt-secret-key
      remoteRef:
        key: {{ .Values.externalSecrets.vault.path }}
        property: jwt-secret-key
{{- end }}
{{- end }}
